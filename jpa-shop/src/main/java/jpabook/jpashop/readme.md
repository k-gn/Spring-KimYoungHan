## 연관관계 매핑

- 용어 (고려사항)
    - 방향 : 양방향, 단방향
    - 다중성 : 다대일, 일대다, 일대일, 다대다
    - 연관관계의 주인 : 양방향 연관관계는 주인이 필요 
        - 두 객체 연관관계 중 하나를 정해서 테이블의 외래키를 관리해야 하는데 이것을 연관관계의 주인(Owner)이라고 한다.
    
* 가급적 안시 표준 조인을 사용해야 다른 데이터베이스로 바꿔도 무리가 없다.

- 객체를 테이블에 맞추어 데이터 중심으로 모델링하면 협력 관계를 만들 수 없다.
    - 테이블은 외래키 하나로 조인을 사용해 연관된 테이블을 찾는다.
    - 객체는 참조를 사용해 연관된 객체를 찾는다. (객체의 양방향 관계는 서로다른 단방향의 참조관계가 2개이다.)
    
---

### @ManyToOne

- @JoinColumn 생략 가능

### @OneToMany 

- @JoinColumn을 꼭 사용해야 한다. 그렇지 않으면 조인 테이블 방식을 사용한다.(중간에 테이블을 하나 추가한다.)
- @OneToMany 를 추가하고 양방향 매핑을 사용하면 연관 관계의 주인을 mappedBy 로 지정 (대상이 되는 변수명)
  - Many-외래키가 있는 쪽이 주인이다.
    - 외래키가 없는 곳을 주인으로 할 경우 매우 불편하다. (다른 테이블의 외래 키를 관리해야함, 성능 이슈도 존재))
  - 주인만 외래키를 관리(등록, 수정)하고, 주인이 아닌쪽은 읽기만 가능

- 양방향 매핑시 가장 많이 하는 실수 : 연관관계의 주인에 값을 입력하지 않음
  - 순수 객체 상태를 고려해서 항상 양쪽에 값을 설정하자 (연관관계 편의 메소드를 생성하자)
  - 순수한 객체까지 고려한 연관관계로 객체 관점에서 양쪽에 모두 값을 넣어주는 것이 안전하다.
  - 양방향 매핑시에 무한 루프를 조심하자 
      - 예: toString(), lombok, JSON 생성 라이브러리
      - toString lombok 은 왠만하면 쓰지말고, 컨트롤러에서 엔티티를 DTO로 만들어 반환하자.

- 단방향 매핑만으로도 이미 연관관계 매핑은 완료 / 양방향 매핑은 반대 방향으로 조회(객체 그래프 탐색) 기능이 편의를 위해 추가된 것 뿐이다.
- 기본적으로 단방향 매핑으로 하고 나중에 역방향으로 객체 탐색이 꼭 필요하다고 느낄 때 추가한다. (가급적 단방향이 좋다.)

--- 

### 다대일
- 단방향
  - 가장 많이 사용한다.
  - @ManyToOne
  - 다 쪽이 외래키를 가지고 있다.
  - 외래키가 있는곳에 참조를 걸어 연관관계 매핑을 하는 것
  
- 양방향
  - 반대쪽에 @OneToMany(mappedBy = "name") 를 추가하면 된다.

### 일대다
- 단방향
  - 1인 곳이 연관관계 주인
  - 외래키는 여전히 Many 쪽에 있고, 연관관계 매핑 시 추가로 Many 쪽에 외래키 Update 쿼리가 발생한다.
      - 반대편 테이블의 외래키를 관리하는 특이한 구조 (매우 불편하고 헷갈림)
  - @OneToMany
  - 권장하진 않음 (다대일 양방향을 사용하는걸 권장)
  - @JoinColumn 을 쓰지 않으면 중간테이블을 만들기 때문에 꼭 사용해야한다. (중간테이블 자체가 성능상 별로고, 운영이 쉽지않음)
  - 코드만으로 파악하기 힘든 쿼리 발생으로 헷갈릴 수 있다.

- 양방향
  - 야매로 사용가능한 방법 (공식적으로 존재하지 않음)
  - 다 쪽에 @ManyToOne + @JoinColumn(insertable=false, updatable=false) 를 추가한다. (읽기전용 필드를 사용)
  - 그냥 다대일 양방향 사용하자.

### 일대일
- 주 테이블이나 대상 테이블 중에 외래키 선택 가능
- 외래키에 데이터베이스 유니크 조건 추가
- @OneToOne
- @JoinColumn 필수

- 주 테이블에 외래키 단방향
  - 다대일 단방향과 유사하다. (제일 잘 쓴다.)

- 주 테이블에 외래키 양방향
  - @OneToOne 에 mappedBy 속성을 명시한다.

- 대상 테이블에 외래키 단방향
  - 지원하지 않음

- 대상 테이블에 외래키 양방향
  - 주 테이블에 외래키 양방향과 동일

- 딜레마가 있다.
  - 비즈니스 변동에 의한 수정
  - 명확하게 1대1 관계인지 초반 설계가 중요한 것 같다. (이 때 주 테이블에 외래키를 두는게 편함)

- 주 테이블에 외래키
  - 주 객체가 대상 객체의 참조를 가지는 것처럼 주 테이블에 외래키를 두고 대상 테이블을 찾는다.
  - 객체지향적
  - JPA 매핑 편리
  - 주 테이블만 조회해도 대상 테이블 데이터 확인 가능
  - 외래키에 null 허용

- 대상 테이블에 외래키
  - 대상 테이블에 외래키 존재
  - 데이터베이스 개발자가 선호
  - 주 테이블과 대상 테이블을 일대다 관계로 변경 시 구조 유지 가능
  - 프록시 기능의 한계로 지연로딩 설정을 해도 항상 즉시 로딩이 된다.
    - 지연로딩 시 연관된 엔티티가 있으면 프록시 객체가 대신 들어가면 되지만, 없으면 null 이 들어가야 한다.
    - 주 테이블에 외래키가 있으면 값이 있는지 없는지 주 테이블을 로딩하는 시점에 외래키 컬럼을 보고 확인할 수 있다.

### 다대다
- 중간 테이블을 추가해서 일대다, 다대일로 풀어낸다.
- @ManyToMany
- @JoinTable 로 연결 테이블 지정
- 단방향, 양방향 둘다 가능 (양방향 시 mappedBy 지정)
- 쓰면 안된다. (편해보이지만 실무에서 사용하면 안된다 -> 중간테이블을 수정할 수 없음)
- 중간 엔티티를 직접 만들고 일대다, 다대일로 직접 사용하는 것을 권장한다.

- 데이터베이스 설계 시 기본키값은 어딘가에 종속되어 설계하는것 보다 의미없는 값이나 자동 증가값으로 만드는 것을 권장한다. (확장성 및 유지보수에 좋음) 
  - 필요한 제약조건은 따로 추가하면 된다.

---

- 일대다 단방향 매핑의 문제는, 매핑한 객체가 관리하는 외래 키가 다른 테이블에 있다는점 -> 관리가 어렵다.
- 가끔 JPA 값 타입을 사용하는 것을 대신하여 사용할 때는 유용한 경우가 있다.
- 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하는 것을 권장
- 사실 일대다 양방향 매핑은 존재하지 않음.

- 일대일 관계는 주 테이블에 외래키를 넣을 수도 있고, 대상 테이블에 외래키를 넣을 수도 있다. 
  - 일대일(1:1) 단방향 지원 안함
  - 일대일 관계라고 정하는 것 자체를 아주 신중하게 정했다고 가정한다면 주 테이블(Post)에 외래 키를 두는 것이 더 낫다.
